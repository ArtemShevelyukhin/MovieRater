<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}MovieRater{% endblock %}</title>

  {% block head_styles %}
  <style>
    :root {
      --bg: #0d0d0d;
      --surface: #141414;
      --text: #e0e0e0;
      --text-secondary: #a0a0a0;
      --accent: #e50914;
      --star: #ffd700;
      --border: #222;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }

    header {
      padding: 12px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .menu-btn { font-size: 1.6rem; background:none; border:none; color:var(--text); cursor:pointer; }
    .room-name { font-size: 1.1rem; font-weight: 600; }

    main {
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 28px;
    }

    footer {
      padding: 12px 16px;
      background: var(--surface);
      border-top: 1px solid var(--border);
    }

    .bottom-nav {
      display: flex;
      justify-content: space-around;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
      font-size: 0.8rem;
      text-decoration: none;
    }

    .nav-item.active { color: var(--text); font-weight: 600; }
    .nav-item span { font-size: 1.5rem; }

    @media (min-width: 480px) {
      main { padding: 24px; }
    }
  </style>
  {% endblock %}

  {% block extra_head %}{% endblock %}
</head>
<body>

  <header>
    <button class="menu-btn" aria-label="–ú–µ–Ω—é">‚ò∞</button>
    <div class="room-name">{% block room_name %}MovieRater{% endblock %}</div>
    <div></div>
  </header>

  <main>
    {% block content %}
    {% endblock %}
    <div id="telegram-login"></div>
  </main>

  <footer>
      <nav class="bottom-nav">
          {# –°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—é #}
          <a href="javascript:void(0)"
             onclick="safeNavigate('{{ url_for('get_room_history', room_id=room.id) if room else '#' }}')"
             class="nav-item">
              <span>üìúÔ∏è</span><span>–ò—Å—Ç–æ—Ä–∏—è</span>
          </a>

          {# –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª—å–º (–≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –∫–æ–º–Ω–∞—Ç—ã) #}
          <a href="{% if room %}{{ url_for('show_room', room_id=room.id) }}{% else %}#{% endif %}"
             class="nav-item {% if 'history' not in request.url.path and 'stats' not in request.url.path %}active{% endif %}">
              <span>üé¨</span><span>–§–∏–ª—å–º</span>
          </a>

          {# –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ #}
          <a href="#" class="nav-item">
              <span>üìä</span><span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
          </a>
      </nav>
  </footer>

  {% block scripts %}
  {% endblock %}

</body>
</html>

<!-- JS –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback -->
<script>
function safeNavigate(baseUrl) {
    if (baseUrl === '#') return;

    const initData = window.Telegram.WebApp.initData;
    const separator = baseUrl.includes('?') ? '&' : '?';

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ –∞–¥—Ä–µ—Å—É /rooms/ID/history?_auth=...
    window.location.href = baseUrl + separator + "_auth=" + encodeURIComponent(initData);
}
function onTelegramAuth(user) {
    fetch('/auth/telegram', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(user)
    }).then(response => {
        if (response.ok) {
            window.location.href = '/';  // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
        } else {
            alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        }
    });
}
</script>