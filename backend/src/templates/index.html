<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MovieRater Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="app-root">
    </div>

    <script>
        const webApp = window.Telegram.WebApp;
        webApp.ready();

        const root = document.getElementById('app-root');

        async function navigateTo(url) {
            try {
                const response = await fetch(url, {
                    headers: {'X-Telegram-Init-Data': webApp.initData}
                });
                const html = await response.text();

                // Вставляем HTML в корень
                root.innerHTML = html;

                // ВАЖНО: Скрипты внутри innerHTML не исполняются автоматически.
                // Нужно вручную найти и запустить их, либо использовать делегирование.
                executeScripts(root);
            } catch (err) {
                console.error('Navigation error:', err);
            }
        }

        function executeScripts(container) {
            const scripts = container.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        }

        // Первичная загрузка
        async function initApp() {
            const response = await fetch('/rooms', {
                headers: {'X-Telegram-Init-Data': webApp.initData}
            });
            const data = await response.json();
            if (data.room_id) {
                navigateTo(`/rooms/${data.room_id}`);
            }
        }

        initApp();
    </script>
</body>
</html>