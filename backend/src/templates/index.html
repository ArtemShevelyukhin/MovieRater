<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MovieRater Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <h1>Информация о пользователе</h1>
    <div id="user-info">Загрузка...</div>

    <script>
        const webApp = window.Telegram.WebApp;
        webApp.ready();

        const userInfoDiv = document.getElementById('user-info');
        const user = webApp.initDataUnsafe.user;

        if (!user) {
            userInfoDiv.innerHTML = 'Данные пользователя недоступны';
        }

        // Отображаем информацию о пользователе сразу
        userInfoDiv.innerHTML = `
            ID: ${user.id}<br>
            Username: ${user.username || 'Не указан'}<br>
            Имя: ${user.first_name || 'Не указано'}<br>
            Фамилия: ${user.last_name || 'Не указана'}
        `;

        // Асинхронная функция для загрузки комнаты
        async function loadRoom() {
            try {
                const response = await fetch('/rooms', {
                    method: 'GET',
                    headers: {
                        'X-Telegram-Init-Data': webApp.initData
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Ошибка аутентификации. Попробуйте перезапустить приложение.');
                    } else {
                        throw new Error(`Сервер вернул ${response.status}`);
                    }
                    return;
                }

                const data = await response.json();

                if (data.status === 'success' && data.room_id) {
                    // Загружаем страницу комнаты
                    const roomResponse = await fetch(`/rooms/${data.room_id}`, {
                        method: 'GET',
                        headers: {
                            'X-Telegram-Init-Data': webApp.initData
                        }
                    });

                    if (!roomResponse.ok) {
                        throw new Error(`Не удалось загрузить комнату: ${roomResponse.status}`);
                    }

                    const html = await roomResponse.text();
                    document.open();
                    document.write(html);
                    document.close();
                }
                else if (data.status === 'no_rooms') {
                    userInfoDiv.innerHTML += '<br><br><strong>У вас пока нет комнат</strong>';
                    // Здесь можно позже вставить кнопку или форму создания/поиска комнаты
                    // window.location.href = '/rooms/search'; // или рендер формы
                }
                else {
                    alert('Неизвестный ответ от сервера');
                }
            }
            catch (err) {
                console.error('Ошибка при загрузке:', err);
                userInfoDiv.innerHTML += `<br><br><span style="color:red">Ошибка: ${err.message}</span>`;
            }
        }
        // Запускаем загрузку
        loadRoom();
    </script>
</body>
</html>