{% extends "base.html" %}

{% block title %}История просмотров{% endblock %}

{% block head_styles %}
{{ super() }}
<style>
    .history-container { width: 100%; max-width: 600px; }
    .sort-block { margin-bottom: 20px; font-size: 0.9rem; color: var(--text-secondary); }
    .sort-link { color: var(--accent); text-decoration: none; margin-left: 8px; }
    .sort-link.active { font-weight: bold; border-bottom: 1px solid var(--accent); }

    .movie-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 16px;
        display: grid;
        grid-template-columns: 80px 1fr auto;
        gap: 12px;
        align-items: start;
    }

    button.sort-link {
        background: none;
        border: none;
        padding: 0;
        font: inherit;
        cursor: pointer;
        outline: inherit;
    }

    .poster-side { display: flex; flex-direction: column; gap: 4px; }
    .mini-poster { width: 80px; border-radius: 8px; object-fit: cover; }
    .movie-title { font-size: 1rem; font-weight: bold; grid-column: 1 / 4; margin-bottom: 4px; }

    .info-col { font-size: 0.85rem; color: var(--text-secondary); }
    .val { color: var(--text); font-weight: 600; font-size: 1rem; display: block; }
    .clickable-avg { color: var(--star); cursor: pointer; text-decoration: underline; }

    /* Modal Styles */
    #modal-overlay {
        display: none; position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center;
    }
    .modal-content {
        background: var(--surface); padding: 20px; border-radius: 16px; width: 80%;
        max-width: 300px; border: 1px solid var(--border);
    }
    .modal-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }

    /* Добавить в блок head_styles */
    .clickable-my-rating {
        color: var(--accent);
        cursor: pointer;
        text-decoration: underline;
        transition: opacity 0.2s;
    }

    .clickable-my-rating:hover {
        opacity: 0.8;
    }

    /* Стили для выбора оценки в модальном окне */
    .rating-picker {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 15px;
    }

    .rating-option {
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--border);
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .rating-option:hover {
        background: var(--accent);
        color: white;
    }

</style>
{% endblock %}

{% block content %}
<div class="history-container">
    <div class="sort-block">
        Сортировать по:

        <button type="button"
                class="sort-link {% if current_sort == 'date' %}active{% endif %}"
                onclick="safeNavigate('{{ url_for('get_room_history', room_id=room_id) }}?sort_by=date')">
            Дате
        </button>

        <button type="button"
                class="sort-link {% if current_sort == 'avg_rating' %}active{% endif %}"
                onclick="safeNavigate('{{ url_for('get_room_history', room_id=room_id) }}?sort_by=avg_rating')">
            Cредней Оценке
        </button>

        <button type="button"
                class="sort-link {% if current_sort == 'my_rating' %}active{% endif %}"
                onclick="safeNavigate('{{ url_for('get_room_history', room_id=room_id) }}?sort_by=my_rating')">
            Моей Оценке
        </button>
    </div>

    {% for item in history %}
    <div class="movie-card">
        <div class="movie-title">{{ item.movie.title }}</div>

        <div class="poster-side">
            <img src="/{{ item.movie.poster_preview_url or '/static/default_poster.jpg' }}" class="mini-poster">
        </div>

        <div class="info-col">
            <span>Средняя</span>
            <span class="val clickable-avg" onclick='showRatings({{ item.details | tojson }})'>
                ★ {{ item.avg_score }}
            </span>
            <br>
            <span>Моя</span>
            <span class="val clickable-my-rating"
                  onclick="openEditRatingModal({{ item.movie.id }}, '{{ item.movie.title }}')">
                {{ item.my_score }}
            </span>
        </div>

        <div class="info-col" style="text-align: right;">
            <span>Выбрал</span>
            <span class="val">{{ item.added_by }}</span>
            <br>
            <span>Дата</span>
            <span class="val" style="font-size: 0.8rem;">{{ item.added_date }}</span>
        </div>
    </div>
    {% endfor %}
</div>

<div id="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-bottom: 12px;">Оценки участников</h3>
        <div id="modal-list"></div>
        <button onclick="closeModal()" style="margin-top:16px; width:100%; padding:8px; background:var(--accent); border:none; color:white; border-radius:8px;">Закрыть</button>
    </div>
</div>

<div id="edit-rating-overlay" onclick="closeEditModal()" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 1001; align-items: center; justify-content: center;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="edit-movie-title" style="margin-bottom: 12px; font-size: 1rem;">Изменить оценку</h3>
        <div class="rating-picker">
            {% for i in range(0, 11) %}
            <div class="rating-option" onclick="submitNewRating({{ i }})">{{ i }}</div>
            {% endfor %}
        </div>
        <button onclick="closeEditModal()" style="margin-top:20px; width:100%; padding:8px; background:transparent; border:1px solid var(--border); color:var(--text-secondary); border-radius:8px;">Отмена</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showRatings(details) {
    const list = document.getElementById('modal-list');
    list.innerHTML = '';
    details.forEach(d => {
        list.innerHTML += `<div class="modal-row"><span>${d.name}</span><strong>${d.score}</strong></div>`;
    });
    document.getElementById('modal-overlay').style.display = 'flex';
}

function closeModal() {
    document.getElementById('modal-overlay').style.display = 'none';
}

// Добавить в блок scripts
let selectedMovieId = null;

function openEditRatingModal(movieId, movieTitle) {
    selectedMovieId = movieId;
    document.getElementById('edit-movie-title').innerText = `Оценить: ${movieTitle}`;
    document.getElementById('edit-rating-overlay').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('edit-rating-overlay').style.display = 'none';
    selectedMovieId = null;
}

async function submitNewRating(score) {
    if (!selectedMovieId) return;

    try {
        const response = await fetch("{{ url_for('submit_rating', room_id=room_id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Telegram-Init-Data': window.Telegram?.WebApp?.initData || ""
            },
            body: JSON.stringify({
                movie_id: selectedMovieId,
                score: score
            })
        });

        if (response.ok) {
            // Перезагружаем страницу для обновления средних и личных оценок
            window.location.reload();
        } else {
            alert("Ошибка при сохранении оценки history.html");
        }
    } catch (err) {
        console.error("Network error:", err);
    } finally {
        closeEditModal();
    }
}
</script>
{% endblock %}